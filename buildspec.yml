version: 0.2

phases:
  install:
    on-failure: ABORT
    commands:
      - echo "Downloading AWS Lightsail Control Plugin..."
      - curl "https://s3.us-west-2.amazonaws.com/lightsailctl/latest/linux-amd64/lightsailctl" -o "/usr/local/bin/lightsailctl"
      - chmod +x /usr/local/bin/lightsailctl
      - echo "Lightsail plugin successfully installed."
      
  pre_build:
    commands:
      - echo "Showing env..."
      - env
      
  build:
    on-failure: ABORT
    commands:
      - |
        echo "Parsing HEAD_REF: $CODEBUILD_WEBHOOK_HEAD_REF"
        APP_VERSION=$( echo $CODEBUILD_WEBHOOK_HEAD_REF | cut -d '/' -f 3 )
        # Default to main branch (development)
        [ -z "$APP_VERSION" ] && APP_VERSION="main"

        echo "Building the Docker image for Python Cowsay version ${APP_VERSION}..."
        docker build -t $IMAGE_NAME:$APP_VERSION .
        docker images $IMAGE_NAME:$APP_VERSION
  
  post_build:
    on-failure: ABORT
    commands:
      - |
        APP_VERSION=$( echo $CODEBUILD_WEBHOOK_HEAD_REF | cut -d '/' -f 3 )
        # Default to main branch (development)
        [ -z "$APP_VERSION" ] && APP_VERSION="main"
        
        echo "Pushing image to Lightsail container service..."
        aws lightsail push-container-image --region $AWS_REGION --service-name $LIGHTSAIL_SERVICE_NAME --label $IMAGE_NAME --image $IMAGE_NAME:$APP_VERSION || echo "FAILS"
      
